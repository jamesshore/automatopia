// Copyright Titanium I.T. LLC. License granted under terms of "The MIT License."
import { assert, test } from "tests";
import * as ensure from "util/ensure.js";
import Reporter from "tasks/reporter.js";
import ConsoleOutput from "infrastructure/console_output.js";
import Clock from "infrastructure/clock.js";
import Colors from "infrastructure/colors.js";

const IRRELEVANT_TEXT = "irrelevant_text";
const TIME = Colors.brightWhite.dim(" (0.00s)\n");
const FAILURE = Colors.brightRed.inverse("X");

export default test(({ describe }) => {

	describe("reports", ({ it }) => {

		it("writes headline, progress, and footer", async () => {
			const { reporter, stdout } = create();

			await reporter.startAsync("my headline", (report) => {
				report.progress();
				report.progress();
				report.progress();
				report.footer("footer 1");
				report.footer("footer 2");
			});

			assertStdoutEqual(stdout, `my headline: ...${TIME}footer 1footer 2`);
		});

		it("returns result of report function", async () => {
			const { reporter } = create();

			const result1 = await reporter.startAsync(IRRELEVANT_TEXT, () => {
				return 1234;
			});
			assert.equal(result1, 1234);

			const result2 = await reporter.quietStartAsync(IRRELEVANT_TEXT, () => {
				return 5678;
			});
			assert.equal(result2, 5678);
		});

		it("writes failures as a convenience function", async () => {
			const { reporter, stdout } = create();

			await reporter.startAsync("my headline", report => {
				report.failure();
				report.failure("my_footer\n");
				report.failure("another_footer", { text: "my text" });
			});

			assertStdoutEqual(stdout, `my headline: ${FAILURE}${FAILURE}my text${TIME}my_footer\nanother_footer`);
		});

		it("always writes at least one progress dot", async () => {
			const { reporter, stdout } = create();

			await reporter.startAsync("my headline", () => {});

			assertStdoutEqual(stdout, `my headline: .${TIME}`);
		});

		it("writes progress dot and footer even when exception is thrown", async () => {
			const { reporter, stdout } = create();

			await assert.errorAsync(
				() => reporter.startAsync("my headline", (report) => {
					report.footer("my footer");
					throw new Error("my error");
				}),
				"my error",
				"should throw exception"
			);

			assertStdoutEqual(stdout, `my headline: .${TIME}my footer`, "should write dot and footer");
		});

		it("allows progress text to be specified", async () => {
			const { reporter, stdout } = create();

			await reporter.startAsync("my headline", report => {
				report.progress({ text: "X" });
			});

			assertStdoutEqual(stdout, `my headline: X${TIME}`);
		});

		it("provides elapsed time", async () => {
			const { reporter, clock } = create();

			await reporter.startAsync(IRRELEVANT_TEXT, async (report) => {
				await clock.tickAsync(1234);
				assert.equal(report.elapsedMs, 1234);
			});
		});

		it("writes elapsed time", async () => {
			const { reporter, stdout, clock } = create();

			await reporter.startAsync("my headline", async (report) => {
				report.progress();
				await clock.tickAsync(1234);
			});

			assertStdoutEqual(stdout, `my headline: .${Colors.brightWhite.dim(" (1.23s)\n")}`);
		});

		it("always writes footer last", async () => {
			const { reporter, stdout } = create();

			await reporter.startAsync("my headline", (report) => {
				report.footer("footer");
				report.progress();
			});

			assertStdoutEqual(stdout, `my headline: .${TIME}footer`);
		});

	});


	describe("quiet reports", ({ it }) => {

		it("doesn't write quiet reports' headline until they explicitly say been started", async () => {
			const { reporter, stdout } = create();

			await reporter.quietStartAsync("my headline", (report) => {
				assertStdoutEqual(stdout, "");
				report.started();
				assertStdoutEqual(stdout, "my headline: ");
			});
		});

		it("quiet reports consider progress to be equivalent to starting", async () => {
			const { reporter, stdout } = create();

			await reporter.quietStartAsync("my headline", (report) => {
				assertStdoutEqual(stdout, "");

				report.progress();
				assertStdoutEqual(stdout, "my headline: .");
			});
		});

		it("doesn't write quiet headlines at all if the report isn't started and there's no footer", async () => {
			const { reporter, stdout } = create();

			await reporter.quietStartAsync("my headline", () => {});
			assertStdoutEqual(stdout, "");
		});

		it("does write quiet headlines if there's a footer, even if there's no progress", async () => {
			const { reporter, stdout } = create();

			await reporter.quietStartAsync("my headline", (report) => {
				report.footer("footer");
			});

			assertStdoutEqual(stdout, `my headline: .${TIME}footer`);
		});

		it("does write quiet headlines if there's an exception, even if there's no progress or footer", async () => {
			const { reporter, stdout } = create();

			await assert.errorAsync(
				() => reporter.quietStartAsync("my headline", (report) => {
					throw new Error("my error");
				}),
				"my error",
			);

			assertStdoutEqual(stdout, `my headline: .${TIME}`);
		});

	});


	describe("tracking", ({ it }) => {

		it("tracks usage", async () => {
			const { reporter } = create();

			const output = reporter.trackUsage();

			await reporter.startAsync("report1", async (report1) => {
				assert.equal(output.data, [
					{ "report1": { action: "started" } },
				]);

				output.consume();
				await reporter.quietStartAsync("report2", (report2) => {
					assert.equal(output.data, []);
					report2.started();
					assert.equal(output.data, [
						{ "report2": { action: "started" } },
					]);

					output.consume();
					report1.progress();
					report2.progress({ debug: "my details" });
					report1.failure("", { debug: "my failure" });
					report2.failure("my failure footer", { debug: "my failure" });
					assert.equal(output.data, [
						{ "report1": { action: "progress", debug: "" } },
						{ "report2": { action: "progress", debug: "my details" } },
						{ "report1": { action: "progress", debug: "my failure" } },
						{ "report2": { action: "progress", debug: "my failure" } },
						{ "report2": { action: "footer", text: "my failure footer" } },
					]);

					output.consume();
					report1.footer("footer1");
					report1.footer("footer2");
					assert.equal(output.data, [
						{ "report1": { action: "footer", text: "footer1" } },
						{ "report1": { action: "footer", text: "footer2" } },
					]);

					output.consume();
				});
			});
			assert.equal(output.data, [
				{ "report2": { action: "end" }},
				{ "report1": { action: "end" }},
			]);
		});

		it("doesn't track default progress dot", async () => {
			const { reporter } = create();

			const output = reporter.trackUsage();

			await reporter.startAsync("report", () => {});
			assert.equal(output.data, [
				{ "report": { action: "started" } },
				{ "report": { action: "end" } },
			]);
		});

	});

});

function create() {
	ensure.signature(arguments, []);

	const clock = Clock.createNull();
	const stdout = ConsoleOutput.createNull();
	const stdoutTracker = stdout.track();

	const reporter = new Reporter(stdout, clock);

	return {
		reporter,
		stdout: stdoutTracker.data,
		clock,
	};
}

function assertStdoutEqual(stdout, expected, message) {
	assert.equal(stdout.join(""), expected, message);
}